{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://pybun.dev/schema/cli-output/v1.json",
  "title": "PyBun CLI JSON Envelope",
  "type": "object",
  "required": [
    "version",
    "command",
    "status",
    "duration_ms",
    "detail",
    "events",
    "diagnostics"
  ],
  "properties": {
    "version": {
      "type": "string",
      "const": "1"
    },
    "command": {
      "type": "string"
    },
    "status": {
      "type": "string",
      "enum": ["ok", "error"]
    },
    "duration_ms": {
      "type": "integer",
      "minimum": 0
    },
    "detail": {
      "type": "object",
      "additionalProperties": true
    },
    "events": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/event"
      }
    },
    "diagnostics": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/diagnostic"
      }
    },
    "trace_id": {
      "type": "string"
    }
  },
  "additionalProperties": false,
  "$defs": {
    "event": {
      "type": "object",
      "required": ["type", "timestamp_ms"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "command_start",
            "command_end",
            "resolve_start",
            "resolve_progress",
            "resolve_complete",
            "install_start",
            "download_start",
            "download_progress",
            "download_complete",
            "extract_start",
            "extract_complete",
            "install_complete",
            "env_create",
            "env_activate",
            "script_start",
            "script_end",
            "cache_hit",
            "cache_miss",
            "cache_write",
            "python_list_start",
            "python_list_complete",
            "python_install_start",
            "python_install_complete",
            "python_remove_start",
            "python_remove_complete",
            "module_find_start",
            "module_find_complete",
            "lazy_import_start",
            "lazy_import_complete",
            "watch_start",
            "watch_stop",
            "file_change",
            "test_start",
            "test_discovery",
            "test_pass",
            "test_fail",
            "test_skip",
            "test_complete",
            "progress",
            "custom"
          ]
        },
        "timestamp_ms": {
          "type": "integer",
          "minimum": 0
        },
        "data": {
          "type": ["object", "array", "string", "number", "boolean", "null"]
        },
        "progress": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "message": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "diagnostic": {
      "type": "object",
      "required": ["level", "message"],
      "properties": {
        "level": {
          "type": "string",
          "enum": ["error", "warning", "info", "hint"]
        },
        "code": {
          "type": "string"
        },
        "message": {
          "type": "string"
        },
        "file": {
          "type": "string"
        },
        "line": {
          "type": "integer",
          "minimum": 0
        },
        "suggestion": {
          "type": "string"
        },
        "context": {
          "type": ["object", "array", "string", "number", "boolean", "null"]
        }
      },
      "additionalProperties": false
    }
  }
}
